server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name 106.52.180.239 _;
    root /var/www/html;
    index index.html;
    
    # 管理系统前端 - 静态HTML文件 (必须在 /api/ 之前)
    location = /admin-system {
        alias /var/www/FORMU_FORMAL/admin_system/admin.html;
        add_header Cache-Control "no-cache";
    }
    
    location = /admin-system/ {
        alias /var/www/FORMU_FORMAL/admin_system/admin.html;
        add_header Cache-Control "no-cache";
    }
    
    # 管理系统API - 直接代理 (必须在 /api/ 之前)
    location /api/admin/ {
        proxy_pass http://127.0.0.1:8001/api/admin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        
        # 处理 OPTIONS 请求
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 主系统API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 文件上传
    location /upload {
        proxy_pass http://127.0.0.1:8000/upload;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;
    }
    
    # 提示词生成
    location /prompt-generation {
        proxy_pass http://127.0.0.1:8000/prompt-generation;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;
    }
    
    # 3D生成
    location /3d-generation {
        proxy_pass http://127.0.0.1:8000/3d-generation;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Sora服务
    location /sora {
        proxy_pass http://127.0.0.1:8000/sora;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态文件上传目录
    location /uploads/ {
        alias /var/www/FORMU_FORMAL/backend/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 所有其他请求
    location / {
        try_files $uri $uri/ /index.html;
    }
}
